<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phishing Detection Game v2.0</title>
<style>
/* ============================================
   CSS VARIABLES FOR THEMING
   ============================================ */
:root {
  --bg-primary: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  --bg-card: rgba(255, 255, 255, 0.15);
  --bg-overlay: rgba(0, 0, 0, 0.3);
  --text-primary: #ffffff;
  --text-secondary: #e0e0e0;
  --text-muted: #aaaaaa;
  --accent-primary: #00d4ff;
  --accent-success: #00ff88;
  --accent-danger: #ff4444;
  --accent-warning: #ffa500;
  --accent-gold: #FFD700;
  --border-color: rgba(255, 255, 255, 0.2);
  --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.dark-mode {
  --bg-primary: linear-gradient(135deg, #000000, #1a1a1a, #0a0a0a);
  --bg-card: rgba(40, 40, 40, 0.95);
  --text-primary: #ffffff;
  --text-secondary: #cccccc;
  --text-muted: #888888;
  --border-color: rgba(255, 255, 255, 0.1);
}

/* ============================================
   BASE STYLES
   ============================================ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-primary);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  color: var(--text-primary);
  padding: 20px;
  transition: background 0.3s ease;
}

.container {
  max-width: 800px;
  width: 100%;
}

/* ============================================
   HEADER
   ============================================ */
header {
  text-align: center;
  margin-bottom: 30px;
  position: relative;
}

h1 {
  font-size: 2.5em;
  margin-bottom: 10px;
  text-shadow: 2px 2px 10px rgba(0, 255, 255, 0.5);
}

.subtitle {
  font-size: 1.1em;
  color: var(--accent-primary);
  opacity: 0.9;
}

#darkModeToggle {
  position: absolute;
  top: 0;
  right: 0;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.2em;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

#darkModeToggle:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
}

/* ============================================
   SCREENS
   ============================================ */
.screen {
  background: var(--bg-card);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 40px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.hidden { display: none; }

/* ============================================
   BUTTONS
   ============================================ */
button {
  padding: 15px 40px;
  font-size: 1.2em;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px var(--bg-overlay);
  text-transform: uppercase;
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent-primary), #0099cc);
  color: #fff;
}

.btn-success {
  background: linear-gradient(135deg, var(--accent-success), #00cc66);
  color: #003322;
}

.btn-danger {
  background: linear-gradient(135deg, var(--accent-danger), #cc0000);
  color: #fff;
}

.btn-warning {
  background: linear-gradient(135deg, var(--accent-warning), #ff8800);
  color: #fff;
}

.btn-gold {
  background: linear-gradient(135deg, var(--accent-gold), #FFA500);
  color: #000;
}

button:not(:disabled):hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
}

/* ============================================
   START SCREEN
   ============================================ */
.start-screen h2 {
  font-size: 2.2em;
  margin-bottom: 20px;
  color: var(--accent-primary);
}

.difficulty-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 30px 0;
}

.difficulty-info {
  font-size: 0.9em;
  color: var(--text-muted);
  margin-top: 5px;
}

.menu-buttons {
  display: flex;
  gap: 15px;
  margin-top: 20px;
}

.menu-buttons button {
  flex: 1;
  padding: 12px 20px;
  font-size: 1em;
}

/* ============================================
   GAME SCREEN
   ============================================ */
.game-info {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  background: var(--bg-card);
  padding: 15px 20px;
  border-radius: 10px;
  backdrop-filter: blur(10px);
}

.game-info > div {
  font-size: 1.1em;
  font-weight: bold;
}

.game-info span {
  color: var(--accent-success);
}

.timer.warning span {
  color: var(--accent-danger);
  animation: pulse 0.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.email-card {
  background: var(--bg-card);
  backdrop-filter: blur(20px);
  border-radius: 15px;
  padding: 30px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
}

.email-header {
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 15px;
  margin-bottom: 15px;
}

.email-subject {
  font-size: 1.4em;
  font-weight: bold;
  margin-bottom: 10px;
  color: var(--accent-primary);
}

.email-from {
  font-size: 1em;
  color: var(--text-muted);
}

.email-from span {
  color: var(--text-primary);
  font-weight: bold;
}

.email-body {
  font-size: 1.1em;
  line-height: 1.6;
  color: var(--text-secondary);
  margin-top: 15px;
}

/* Fake link styling */
.email-link {
  color: var(--accent-primary);
  text-decoration: underline;
  cursor: pointer;
  position: relative;
}

.email-link.suspicious {
  color: var(--accent-danger);
  text-decoration: underline wavy;
  font-weight: bold;
}

.link-tooltip {
  position: absolute;
  bottom: 100%;
  left: 0;
  background: rgba(0, 0, 0, 0.95);
  color: #fff;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 0.9em;
  white-space: nowrap;
  z-index: 1000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
  margin-bottom: 10px;
  display: none;
}

.link-tooltip.show {
  display: block;
  animation: tooltipFade 0.3s ease;
}

@keyframes tooltipFade {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

.link-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 20px;
  border: 8px solid transparent;
  border-top-color: rgba(0, 0, 0, 0.95);
}

.buttons {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-top: 30px;
}

.feedback {
  text-align: center;
  font-size: 1.3em;
  font-weight: bold;
  margin-top: 15px;
  min-height: 30px;
}

.feedback.correct { color: var(--accent-success); }
.feedback.wrong { color: var(--accent-danger); }

/* ============================================
   EXPLANATION PANEL
   ============================================ */
.explanation-panel {
  background: var(--bg-card);
  backdrop-filter: blur(15px);
  border-radius: 12px;
  padding: 25px;
  margin-top: 20px;
  border: 2px solid var(--border-color);
  animation: slideIn 0.4s ease;
  box-shadow: 0 6px 20px var(--bg-overlay);
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.explanation-panel.correct {
  border-color: var(--accent-success);
  background: rgba(0, 255, 136, 0.1);
}

.explanation-panel.wrong {
  border-color: var(--accent-danger);
  background: rgba(255, 68, 68, 0.1);
}

.explanation-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
  font-size: 1.3em;
  font-weight: bold;
}

.explanation-title {
  color: var(--accent-primary);
  font-size: 1.2em;
  margin-bottom: 15px;
  font-weight: bold;
}

.explanation-list {
  list-style: none;
  padding: 0;
}

.explanation-list li {
  padding: 10px 0;
  padding-left: 30px;
  position: relative;
  font-size: 1.05em;
  line-height: 1.5;
  color: var(--text-secondary);
}

.explanation-list li:before {
  content: "‚Ä¢";
  position: absolute;
  left: 10px;
  color: var(--accent-primary);
  font-size: 1.5em;
}

/* ============================================
   LEADERBOARD
   ============================================ */
.leaderboard-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

.leaderboard-table th,
.leaderboard-table td {
  padding: 15px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.leaderboard-table th {
  background: var(--bg-card);
  color: var(--accent-primary);
  font-weight: bold;
  font-size: 1.1em;
}

.leaderboard-table tr:hover {
  background: rgba(0, 212, 255, 0.1);
}

.rank-medal {
  font-size: 1.5em;
  margin-right: 10px;
}

/* ============================================
   ANALYTICS
   ============================================ */
.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.stat-card {
  background: var(--bg-card);
  padding: 20px;
  border-radius: 12px;
  border: 2px solid var(--border-color);
  text-align: center;
}

.stat-value {
  font-size: 2.5em;
  font-weight: bold;
  color: var(--accent-success);
  margin: 10px 0;
}

.stat-label {
  font-size: 1.1em;
  color: var(--text-muted);
}

/* ============================================
   GAME OVER
   ============================================ */
.game-over h2 {
  font-size: 2.5em;
  margin-bottom: 20px;
  color: var(--accent-primary);
}

.final-score {
  font-size: 2em;
  margin: 20px 0;
  color: var(--accent-success);
}

.rank-message {
  font-size: 1.5em;
  margin: 20px 0;
  padding: 20px;
  background: var(--bg-card);
  border-radius: 10px;
}

.name-input {
  padding: 12px 20px;
  font-size: 1.1em;
  border: 2px solid var(--accent-primary);
  border-radius: 8px;
  background: var(--bg-card);
  color: var(--text-primary);
  text-align: center;
  width: 80%;
  max-width: 300px;
  margin: 10px 0;
}

.name-input::placeholder {
  color: var(--text-muted);
}

.difficulty-badge {
  display: inline-block;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 0.9em;
  margin-top: 10px;
}

.badge-easy { background: var(--accent-success); color: #000; }
.badge-medium { background: var(--accent-warning); color: #000; }
.badge-hard { background: var(--accent-danger); color: #fff; }

/* ============================================
   RESPONSIVE DESIGN
   ============================================ */
@media (max-width: 600px) {
  h1 { font-size: 2em; }
  .screen { padding: 20px; }
  .buttons { flex-direction: column; }
  button { width: 100%; }
  #darkModeToggle {
    position: static;
    margin: 10px auto;
    display: block;
  }
  .menu-buttons {
    flex-direction: column;
  }
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <header>
    <h1>üîí Phishing Detection Game v2.0</h1>
    <p class="subtitle">Master the art of spotting phishing emails</p>
    <button id="darkModeToggle">üåô Dark Mode</button>
  </header>

  <!-- Start Screen -->
  <div id="startScreen" class="screen">
    <h2>Phishing Detection Challenge</h2>
    <p style="font-size: 1.1em; margin: 20px 0;">Test your cybersecurity skills! Can you identify phishing emails?</p>
    
    <div class="difficulty-buttons">
      <button class="btn-success" data-difficulty="easy">
        üü¢ Easy
      </button>
      <div class="difficulty-info">30 seconds per email ‚Ä¢ Basic phishing attempts</div>
      
      <button class="btn-warning" data-difficulty="medium">
        üü° Medium
      </button>
      <div class="difficulty-info">20 seconds per email ‚Ä¢ Moderate difficulty</div>
      
      <button class="btn-danger" data-difficulty="hard">
        üî¥ Hard
      </button>
      <div class="difficulty-info">10 seconds per email ‚Ä¢ Expert level challenges</div>
    </div>

    <div class="menu-buttons">
      <button class="btn-primary" id="viewLeaderboardBtn">üèÜ Leaderboard</button>
      <button class="btn-primary" id="viewAnalyticsBtn">üìä Analytics</button>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="screen hidden">
    <div class="game-info">
      <div class="score">Score: <span id="scoreValue">0</span></div>
      <div class="difficulty-label">Level: <span id="difficultyDisplay">Easy</span></div>
      <div class="progress">Email: <span id="emailProgress">1/4</span></div>
      <div class="timer" id="timer">Time: <span id="timeValue">30</span>s</div>
    </div>

    <div class="email-card" id="emailCard">
      <div class="email-header">
        <div class="email-subject" id="emailSubject"></div>
        <div class="email-from">From: <span id="emailFrom"></span></div>
      </div>
      <div class="email-body" id="emailBody"></div>
    </div>

    <div class="buttons">
      <button class="btn-success" id="btnLegit">‚úÖ Legit</button>
      <button class="btn-danger" id="btnPhishing">‚ùå Phishing</button>
    </div>

    <div class="feedback" id="feedback"></div>
    <div id="explanationPanel" class="hidden"></div>
  </div>

  <!-- Game Over Screen -->
  <div id="gameOverScreen" class="screen hidden" style="text-align: center;">
    <h2>üéØ Game Over!</h2>
    <div class="final-score">Final Score: <span id="finalScore">0</span></div>
    <div class="rank-message" id="rankMessage"></div>
    <div id="difficultyBadge"></div>
    
    <div style="margin: 30px 0;">
      <input type="text" id="nameInput" class="name-input" placeholder="Enter your name" maxlength="20">
      <br>
      <button class="btn-gold" id="btnSaveScore" style="margin-top: 15px;">üíæ Save Score</button>
    </div>
    
    <div class="menu-buttons">
      <button class="btn-primary" id="btnRestart">üîÑ Play Again</button>
      <button class="btn-primary" id="btnViewLeaderboard">üèÜ Leaderboard</button>
      <button class="btn-primary" id="btnViewAnalytics">üìä Analytics</button>
    </div>
  </div>

  <!-- Leaderboard Screen -->
  <div id="leaderboardScreen" class="screen hidden">
    <h2 style="color: var(--accent-gold); margin-bottom: 20px;">üèÜ Leaderboard</h2>
    <table class="leaderboard-table" id="leaderboardTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Name</th>
          <th>Score</th>
          <th>Difficulty</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <button class="btn-primary" id="backFromLeaderboard" style="margin-top: 20px;">‚Üê Back to Menu</button>
  </div>

  <!-- Analytics Screen -->
  <div id="analyticsScreen" class="screen hidden">
    <h2 style="color: var(--accent-primary); margin-bottom: 20px;">üìä Performance Analytics</h2>
    <div class="analytics-grid">
      <div class="stat-card">
        <div class="stat-label">Accuracy</div>
        <div class="stat-value" id="accuracyStat">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Time</div>
        <div class="stat-value" id="avgTimeStat">0s</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Played</div>
        <div class="stat-value" id="totalPlayedStat">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Best Streak</div>
        <div class="stat-value" id="bestStreakStat">0</div>
      </div>
    </div>
    <button class="btn-primary" id="backFromAnalytics" style="margin-top: 20px;">‚Üê Back to Menu</button>
  </div>
</div>

<script>
// ============================================
// EMAIL DATABASE
// ============================================
const emails = [
  // EASY EMAILS
  {
    subject: "You've won $1,000,000!!!",
    from: "winner@lottery-claim-center.net",
    body: "CONGRATULATIONS! You have been randomly selected as the winner of our international lottery! To claim your prize of $1,000,000, please provide your bank account details, social security number, and a processing fee of $500. {link:Click here to claim|http://scam-site-evil.com/steal-data} Act now before this offer expires!",
    isPhishing: true,
    difficulty: "easy",
    explanation: [
      "Too good to be true - unsolicited lottery winnings",
      "Requests sensitive personal information",
      "Asks for money upfront to claim a prize",
      "Link text doesn't match actual URL"
    ]
  },
  {
    subject: "Team Meeting Reminder",
    from: "hr@company.com",
    body: "Hi team, This is a reminder that we have our weekly team meeting scheduled for tomorrow at 10:00 AM in Conference Room B. Please review the agenda and come prepared with your project updates.",
    isPhishing: false,
    difficulty: "easy",
    explanation: [
      "Comes from legitimate company domain",
      "Professional tone without urgency",
      "No suspicious links or requests",
      "Specific meeting details provided"
    ]
  },
  {
    subject: "Your package delivery failed",
    from: "delivery@fedx-express.com",
    body: "We attempted to deliver your package but no one was available. To reschedule delivery, {link:click this link|http://fake-fedex-scam.ru/login} and pay a $3.99 redelivery fee. Your package will be returned if not claimed within 48 hours.",
    isPhishing: true,
    difficulty: "easy",
    explanation: [
      "Misspelled domain 'fedx' instead of 'fedex'",
      "Unexpected delivery fee",
      "Creates false urgency",
      "Suspicious link domain (.ru)"
    ]
  },
  {
    subject: "Monthly Newsletter - April 2024",
    from: "newsletter@techcompany.com",
    body: "Welcome to our April newsletter! This month we're featuring new product updates, upcoming webinars, and industry insights. You can unsubscribe anytime from your account settings.",
    isPhishing: false,
    difficulty: "easy",
    explanation: [
      "Legitimate company newsletter",
      "No urgent calls to action",
      "Provides unsubscribe option",
      "No requests for personal data"
    ]
  },

  // MEDIUM EMAILS
  {
    subject: "Urgent! Verify your bank account",
    from: "support@secure-bank-login.com",
    body: "Dear customer, Your account has been temporarily suspended due to suspicious activity. {link:Click here immediately|http://bank-phishing-site.tk/verify} to verify your identity and restore access. Failure to do so within 24 hours will result in permanent account closure.",
    isPhishing: true,
    difficulty: "medium",
    explanation: [
      "Suspicious domain - not official bank",
      "Creates urgency and fear",
      "Generic greeting 'Dear customer'",
      "Link leads to suspicious .tk domain"
    ]
  },
  {
    subject: "Invoice #45821 - Payment Confirmation",
    from: "accounts@vendor.com",
    body: "Thank you for your recent purchase. Your payment of $299.00 has been processed successfully. Please find attached your invoice for order #45821. Contact our support team at support@vendor.com with questions.",
    isPhishing: false,
    difficulty: "medium",
    explanation: [
      "Professional business communication",
      "Specific order and invoice numbers",
      "Legitimate support contact",
      "No suspicious requests"
    ]
  },
  {
    subject: "ACTION REQUIRED: Update Payment Info",
    from: "billing@paypa1-secure.com",
    body: "We noticed an issue with your payment method. Your PayPal account will be limited unless you {link:update your information|http://paypal-phish.com/account} immediately. Click the link below to verify your credit card details.",
    isPhishing: true,
    difficulty: "medium",
    explanation: [
      "Domain uses '1' instead of 'l' in PayPal",
      "Creates false urgency",
      "Requests sensitive payment info",
      "Link doesn't go to paypal.com"
    ]
  },
  {
    subject: "Weekly Report - Q1 Results",
    from: "analytics@company.com",
    body: "Hello, Please find attached the weekly analytics report for Q1. Our team has seen a 15% increase in user engagement this quarter. The detailed breakdown is available in the attached PDF.",
    isPhishing: false,
    difficulty: "medium",
    explanation: [
      "Internal company communication",
      "Professional business language",
      "Specific data and metrics",
      "No suspicious links or requests"
    ]
  },

  // HARD EMAILS
  {
    subject: "Security Alert: New login detected",
    from: "no-reply@app1e-security.com",
    body: "We detected a login to your Apple ID from a device we don't recognize. If this wasn't you, your account may be compromised. {link:Click here to secure your account|http://apple-security-check.xyz/verify} immediately. Location: Russia. Device: Windows PC.",
    isPhishing: true,
    difficulty: "hard",
    explanation: [
      "Domain uses '1' instead of 'l' - subtle trick",
      "Fake security alert to create panic",
      "Suspicious login location to scare user",
      "Link goes to .xyz domain, not apple.com"
    ]
  },
  {
    subject: "Your subscription renewal confirmation",
    from: "subscriptions@streamingservice.com",
    body: "Hi there! Your monthly subscription has been successfully renewed for $12.99. Your next billing date is May 15, 2024. You can manage your subscription settings anytime from your account dashboard.",
    isPhishing: false,
    difficulty: "hard",
    explanation: [
      "Legitimate subscription confirmation",
      "Specific pricing and billing date",
      "No requests for payment info",
      "Directs to account dashboard"
    ]
  },
  {
    subject: "RE: Document Review Required",
    from: "cfo@companylnc.com",
    body: "Hi, I need you to review this contract before our meeting at 3pm today. It's urgent and confidential. I'm in meetings all day so can't call. Please {link:download the document|http://malicious-docs.com/contract.exe} from this secure link and send your approval ASAP.",
    isPhishing: true,
    difficulty: "hard",
    explanation: [
      "Domain uses 'lnc' instead of 'Inc' - subtle typo",
      "Creates urgency and time pressure",
      "Claims sender unavailable to verify",
      "Link goes to .exe file - major red flag"
    ]
  },
  {
    subject: "Expense Report Approved - March 2024",
    from: "finance@company.com",
    body: "Your expense report for March 2024 has been approved. Total reimbursement: $847.32. The amount will be deposited to your account within 3-5 business days. View detailed breakdown in the finance portal.",
    isPhishing: false,
    difficulty: "hard",
    explanation: [
      "Legitimate internal company email",
      "Specific dollar amount and timeframe",
      "Directs to company portal",
      "Provides legitimate contact info"
    ]
  }
];

// ============================================
// GAME STATE
// ============================================
let currentScore = 0;
let currentEmailIndex = 0;
let filteredEmails = [];
let timeLeft = 30;
let timerInterval;
let buttonsEnabled = true;
let selectedDifficulty = 'easy';
let timerDuration = 30;
let recentAnswers = []; // Track last 3 answers for adaptive difficulty
let sessionStats = {
  correctAnswers: 0,
  wrongAnswers: 0,
  totalTime: 0,
  questionsAnswered: 0,
  currentStreak: 0,
  bestStreak: 0
};

// ============================================
// DOM ELEMENTS
// ============================================
const darkModeToggle = document.getElementById('darkModeToggle');
const startScreen = document.getElementById('startScreen');
const gameScreen = document.getElementById('gameScreen');
const gameOverScreen = document.getElementById('gameOverScreen');
const leaderboardScreen = document.getElementById('leaderboardScreen');
const analyticsScreen = document.getElementById('analyticsScreen');

const scoreValue = document.getElementById('scoreValue');
const emailProgress = document.getElementById('emailProgress');
const timeValue = document.getElementById('timeValue');
const timerElement = document.getElementById('timer');
const difficultyDisplay = document.getElementById('difficultyDisplay');
const emailSubject = document.getElementById('emailSubject');
const emailFrom = document.getElementById('emailFrom');
const emailBody = document.getElementById('emailBody');
const emailCard = document.getElementById('emailCard');
const feedback = document.getElementById('feedback');
const btnLegit = document.getElementById('btnLegit');
const btnPhishing = document.getElementById('btnPhishing');
const explanationPanel = document.getElementById('explanationPanel');
const finalScore = document.getElementById('finalScore');
const rankMessage = document.getElementById('rankMessage');
const difficultyBadge = document.getElementById('difficultyBadge');
const nameInput = document.getElementById('nameInput');
const btnSaveScore = document.getElementById('btnSaveScore');

// ============================================
// SOUND EFFECTS
// ============================================
function playSound(isCorrect) {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  if (isCorrect) {
    // Happy sound
    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
  } else {
    // Error sound
    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
  }
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.3);
}

// ============================================
// DARK MODE
// ============================================
function initDarkMode() {
  const darkMode = localStorage.getItem('darkMode');
  if (darkMode === 'enabled') {
    document.body.classList.add('dark-mode');
    darkModeToggle.textContent = '‚òÄÔ∏è Light Mode';
  }
}

darkModeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
  darkModeToggle.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
});

// ============================================
// LEADERBOARD MANAGEMENT
// ============================================
function saveToLeaderboard(name, score, difficulty) {
  let leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
  leaderboard.push({
    name: name || 'Anonymous',
    score: score,
    difficulty: difficulty,
    date: new Date().toISOString()
  });
  
  // Sort by score descending and keep top 10
  leaderboard.sort((a, b) => b.score - a.score);
  leaderboard = leaderboard.slice(0, 10);
  
  localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
}

function displayLeaderboard() {
  const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
  const tbody = document.getElementById('leaderboardBody');
  tbody.innerHTML = '';
  
  if (leaderboard.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">No scores yet. Be the first!</td></tr>';
    return;
  }
  
  leaderboard.forEach((entry, index) => {
    const row = document.createElement('tr');
    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
    const badgeClass = entry.difficulty === 'easy' ? 'badge-easy' : entry.difficulty === 'medium' ? 'badge-medium' : 'badge-hard';
    
    row.innerHTML = `
      <td><span class="rank-medal">${medal}</span>${index + 1}</td>
      <td>${entry.name}</td>
      <td><strong>${entry.score}</strong></td>
      <td><span class="difficulty-badge ${badgeClass}">${entry.difficulty}</span></td>
    `;
    tbody.appendChild(row);
  });
}

// ============================================
// ANALYTICS MANAGEMENT
// ============================================
function saveAnalytics() {
  const analytics = JSON.parse(localStorage.getItem('analytics') || '{"totalCorrect": 0, "totalWrong": 0, "totalTime": 0, "totalQuestions": 0, "bestStreak": 0}');
  
  analytics.totalCorrect += sessionStats.correctAnswers;
  analytics.totalWrong += sessionStats.wrongAnswers;
  analytics.totalTime += sessionStats.totalTime;
  analytics.totalQuestions += sessionStats.questionsAnswered;
  analytics.bestStreak = Math.max(analytics.bestStreak, sessionStats.bestStreak);
  
  localStorage.setItem('analytics', JSON.stringify(analytics));
}

function displayAnalytics() {
  const analytics = JSON.parse(localStorage.getItem('analytics') || '{"totalCorrect": 0, "totalWrong": 0, "totalTime": 0, "totalQuestions": 0, "bestStreak": 0}');
  
  const total = analytics.totalQuestions || 1;
  const accuracy = ((analytics.totalCorrect / total) * 100).toFixed(1);
  const avgTime = (analytics.totalTime / total).toFixed(1);
  
  document.getElementById('accuracyStat').textContent = accuracy + '%';
  document.getElementById('avgTimeStat').textContent = avgTime + 's';
  document.getElementById('totalPlayedStat').textContent = analytics.totalQuestions;
  document.getElementById('bestStreakStat').textContent = analytics.bestStreak;
}

// ============================================
// ADAPTIVE DIFFICULTY
// ============================================
function adjustDifficulty(isCorrect) {
  recentAnswers.push(isCorrect);
  if (recentAnswers.length > 3) {
    recentAnswers.shift();
  }
  
  if (recentAnswers.length === 3) {
    const correctCount = recentAnswers.filter(a => a).length;
    
    // 3 correct in a row -> increase difficulty
    if (correctCount === 3 && selectedDifficulty !== 'hard') {
      const oldDifficulty = selectedDifficulty;
      selectedDifficulty = selectedDifficulty === 'easy' ? 'medium' : 'hard';
      timerDuration = selectedDifficulty === 'medium' ? 20 : 10;
      difficultyDisplay.textContent = selectedDifficulty.charAt(0).toUpperCase() + selectedDifficulty.slice(1);
      
      // Show notification
      showNotification(`üî• Level increased to ${selectedDifficulty}!`, 'success');
      recentAnswers = [];
    }
    // 2+ wrong in last 3 -> decrease difficulty
    else if (correctCount <= 1 && selectedDifficulty !== 'easy') {
      const oldDifficulty = selectedDifficulty;
      selectedDifficulty = selectedDifficulty === 'hard' ? 'medium' : 'easy';
      timerDuration = selectedDifficulty === 'easy' ? 30 : 20;
      difficultyDisplay.textContent = selectedDifficulty.charAt(0).toUpperCase() + selectedDifficulty.slice(1);
      
      // Show notification
      showNotification(`Level adjusted to ${selectedDifficulty}`, 'warning');
      recentAnswers = [];
    }
  }
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    background: ${type === 'success' ? 'var(--accent-success)' : 'var(--accent-warning)'};
    color: #000;
    border-radius: 8px;
    font-weight: bold;
    z-index: 10000;
    animation: slideInRight 0.3s ease;
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 2000);
}

// ============================================
// FAKE LINK DETECTION
// ============================================
function processEmailBody(bodyText) {
  // Replace {link:text|url} with HTML links
  return bodyText.replace(/\{link:(.*?)\|(.*?)\}/g, (match, text, url) => {
    const isSuspicious = !url.toLowerCase().includes(text.toLowerCase().replace(/\s/g, ''));
    const linkClass = isSuspicious ? 'email-link suspicious' : 'email-link';
    return `<a href="${url}" class="${linkClass}" data-url="${url}" onclick="return false;">${text}</a>`;
  });
}

function initLinkHoverDetection() {
  emailBody.addEventListener('mouseover', (e) => {
    if (e.target.classList.contains('email-link')) {
      const url = e.target.dataset.url;
      const text = e.target.textContent;
      
      // Check if link is suspicious
      if (e.target.classList.contains('suspicious')) {
        showLinkTooltip(e.target, url, true);
      } else {
        showLinkTooltip(e.target, url, false);
      }
    }
  });
  
  emailBody.addEventListener('mouseout', (e) => {
    if (e.target.classList.contains('email-link')) {
      hideLinkTooltip();
    }
  });
}

function showLinkTooltip(element, url, isSuspicious) {
  hideLinkTooltip();
  
  const tooltip = document.createElement('div');
  tooltip.className = 'link-tooltip show';
  tooltip.id = 'linkTooltip';
  
  if (isSuspicious) {
    tooltip.innerHTML = `‚ö†Ô∏è <strong>Warning!</strong> This link goes to:<br><code>${url}</code>`;
    tooltip.style.background = 'rgba(255, 68, 68, 0.95)';
  } else {
    tooltip.innerHTML = `‚ÑπÔ∏è Link destination:<br><code>${url}</code>`;
  }
  
  element.appendChild(tooltip);
}

function hideLinkTooltip() {
  const existing = document.getElementById('linkTooltip');
  if (existing) existing.remove();
}

// ============================================
// GAME LOGIC
// ============================================
function prepareEmails() {
  const emailsByDifficulty = emails.filter(email => email.difficulty === selectedDifficulty);
  filteredEmails = [...emailsByDifficulty];
  
  // Shuffle
  for (let i = filteredEmails.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [filteredEmails[i], filteredEmails[j]] = [filteredEmails[j], filteredEmails[i]];
  }
}

function startGame(difficulty) {
  selectedDifficulty = difficulty;
  timerDuration = difficulty === 'easy' ? 30 : difficulty === 'medium' ? 20 : 10;
  
  currentScore = 0;
  currentEmailIndex = 0;
  recentAnswers = [];
  sessionStats = {
    correctAnswers: 0,
    wrongAnswers: 0,
    totalTime: 0,
    questionsAnswered: 0,
    currentStreak: 0,
    bestStreak: 0
  };
  
  prepareEmails();
  updateScore();
  difficultyDisplay.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
  
  hideAllScreens();
  gameScreen.classList.remove('hidden');
  showEmail();
}

function showEmail() {
  if (currentEmailIndex >= filteredEmails.length) {
    endGame();
    return;
  }
  
  buttonsEnabled = true;
  btnLegit.disabled = false;
  btnPhishing.disabled = false;
  
  const email = filteredEmails[currentEmailIndex];
  
  explanationPanel.classList.add('hidden');
  explanationPanel.innerHTML = '';
  
  emailSubject.textContent = email.subject;
  emailFrom.textContent = email.from;
  emailBody.innerHTML = processEmailBody(email.body);
  
  feedback.textContent = '';
  updateProgress();
  startTimer();
}

function updateScore() {
  scoreValue.textContent = currentScore;
}

function updateProgress() {
  emailProgress.textContent = `${currentEmailIndex + 1}/${filteredEmails.length}`;
}

function startTimer() {
  timeLeft = timerDuration;
  timeValue.textContent = timeLeft;
  timerElement.classList.remove('warning');
  
  const startTime = Date.now();
  
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    timeValue.textContent = timeLeft;
    
    if (timeLeft <= 5) {
      timerElement.classList.add('warning');
    }
    
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      const elapsed = (Date.now() - startTime) / 1000;
      sessionStats.totalTime += elapsed;
      handleTimeout();
    }
  }, 1000);
}

function showExplanation(isCorrect) {
  const email = filteredEmails[currentEmailIndex];
  const icon = isCorrect ? '‚úÖ' : '‚ùå';
  const resultClass = isCorrect ? 'correct' : 'wrong';
  
  let explanationHTML = `
    <div class="explanation-panel ${resultClass}">
      <div class="explanation-header">
        <span class="explanation-icon">${icon}</span>
        <span>${isCorrect ? 'Correct!' : 'Wrong!'}</span>
      </div>
      <div class="explanation-title">Why?</div>
      <ul class="explanation-list">
  `;
  
  email.explanation.forEach(reason => {
    explanationHTML += `<li>${reason}</li>`;
  });
  
  explanationHTML += `
      </ul>
      <button class="btn-primary" id="btnNext" style="margin-top: 20px; display: block; margin-left: auto; margin-right: auto;">Next Email ‚Üí</button>
    </div>
  `;
  
  explanationPanel.innerHTML = explanationHTML;
  explanationPanel.classList.remove('hidden');
  
  document.getElementById('btnNext').addEventListener('click', () => {
    currentEmailIndex++;
    showEmail();
  });
}

function handleAnswer(userSaidPhishing) {
  if (!buttonsEnabled) return;
  
  buttonsEnabled = false;
  btnLegit.disabled = true;
  btnPhishing.disabled = true;
  clearInterval(timerInterval);
  
  const email = filteredEmails[currentEmailIndex];
  const isCorrect = userSaidPhishing === email.isPhishing;
  
  // Play sound
  playSound(isCorrect);
  
  // Update session stats
  sessionStats.questionsAnswered++;
  
  if (isCorrect) {
    currentScore += 10;
    sessionStats.correctAnswers++;
    sessionStats.currentStreak++;
    sessionStats.bestStreak = Math.max(sessionStats.bestStreak, sessionStats.currentStreak);
    feedback.textContent = "Correct! üéâ";
    feedback.className = 'feedback correct';
  } else {
    currentScore -= 5;
    sessionStats.wrongAnswers++;
    sessionStats.currentStreak = 0;
    feedback.textContent = "Wrong! ‚ö†Ô∏è";
    feedback.className = 'feedback wrong';
  }
  
  updateScore();
  adjustDifficulty(isCorrect);
  
  setTimeout(() => {
    showExplanation(isCorrect);
  }, 800);
}

function handleTimeout() {
  if (!buttonsEnabled) return;
  
  buttonsEnabled = false;
  btnLegit.disabled = true;
  btnPhishing.disabled = true;
  
  sessionStats.questionsAnswered++;
  sessionStats.wrongAnswers++;
  sessionStats.currentStreak = 0;
  currentScore -= 5;
  
  playSound(false);
  
  feedback.textContent = "Time's up! ‚è∞";
  feedback.className = 'feedback wrong';
  updateScore();
  
  setTimeout(() => {
    showExplanation(false);
  }, 800);
}

function endGame() {
  clearInterval(timerInterval);
  saveAnalytics();
  
  hideAllScreens();
  gameOverScreen.classList.remove('hidden');
  
  finalScore.textContent = currentScore;
  
  if (currentScore > 70) {
    rankMessage.textContent = "üõ°Ô∏è Security Expert!";
    rankMessage.style.color = "var(--accent-success)";
  } else {
    rankMessage.textContent = "üîê Needs Training";
    rankMessage.style.color = "var(--accent-danger)";
  }
  
  const badgeClass = selectedDifficulty === 'easy' ? 'badge-easy' : selectedDifficulty === 'medium' ? 'badge-medium' : 'badge-hard';
  difficultyBadge.innerHTML = `<span class="difficulty-badge ${badgeClass}">${selectedDifficulty.toUpperCase()}</span>`;
}

function hideAllScreens() {
  startScreen.classList.add('hidden');
  gameScreen.classList.add('hidden');
  gameOverScreen.classList.add('hidden');
  leaderboardScreen.classList.add('hidden');
  analyticsScreen.classList.add('hidden');
}

// ============================================
// EVENT LISTENERS
// ============================================

// Difficulty selection
document.querySelectorAll('.btn-success, .btn-warning, .btn-danger').forEach(btn => {
  if (btn.dataset.difficulty) {
    btn.addEventListener('click', (e) => {
      const difficulty = e.currentTarget.dataset.difficulty;
      startGame(difficulty);
    });
  }
});

// Game buttons
btnLegit.addEventListener('click', () => handleAnswer(false));
btnPhishing.addEventListener('click', () => handleAnswer(true));

// Save score
btnSaveScore.addEventListener('click', () => {
  const name = nameInput.value.trim() || 'Anonymous';
  saveToLeaderboard(name, currentScore, selectedDifficulty);
  
  btnSaveScore.textContent = '‚úÖ Saved!';
  btnSaveScore.disabled = true;
  
  setTimeout(() => {
    btnSaveScore.textContent = 'üíæ Save Score';
    btnSaveScore.disabled = false;
  }, 2000);
});

// Navigation
document.getElementById('btnRestart').addEventListener('click', () => {
  hideAllScreens();
  startScreen.classList.remove('hidden');
  nameInput.value = '';
});

document.getElementById('viewLeaderboardBtn').addEventListener('click', () => {
  displayLeaderboard();
  hideAllScreens();
  leaderboardScreen.classList.remove('hidden');
});

document.getElementById('btnViewLeaderboard').addEventListener('click', () => {
  displayLeaderboard();
  hideAllScreens();
  leaderboardScreen.classList.remove('hidden');
});

document.getElementById('backFromLeaderboard').addEventListener('click', () => {
  hideAllScreens();
  startScreen.classList.remove('hidden');
});

document.getElementById('viewAnalyticsBtn').addEventListener('click', () => {
  displayAnalytics();
  hideAllScreens();
  analyticsScreen.classList.remove('hidden');
});

document.getElementById('btnViewAnalytics').addEventListener('click', () => {
  displayAnalytics();
  hideAllScreens();
  analyticsScreen.classList.remove('hidden');
});

document.getElementById('backFromAnalytics').addEventListener('click', () => {
  hideAllScreens();
  startScreen.classList.remove('hidden');
});

// ============================================
// INITIALIZE
// ============================================
initDarkMode();
initLinkHoverDetection();
</script>

</body>
</html>
